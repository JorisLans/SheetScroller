<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Conductor Pro v72 - Precision Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --ink: #111; --paper: #f4f4f4; --white: #fff;
            --accent: #e74c3c; --highlight: rgba(231, 76, 60, 0.25);
            --ui-bg: rgba(255, 255, 255, 0.98);
        }

        body { font-family: 'Georgia', serif; margin: 0; background: var(--paper); color: var(--ink); overflow-x: hidden; }

        /* --- HEADER UI --- */
        #ui-bar {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            background: var(--ui-bg); border-bottom: 2px solid var(--ink);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.4s ease;
        }
        
        .toolbar { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; justify-content: center; align-items: center; }
        .group { display: flex; flex-direction: column; align-items: center; }
        .label { font-size: 9px; font-weight: bold; text-transform: uppercase; color: #666; margin-bottom: 2px; }
        select, input { padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; }
        
        .btn {
            padding: 8px 16px; border: 2px solid var(--ink); background: var(--white);
            font-weight: bold; font-size: 11px; cursor: pointer; text-transform: uppercase;
            box-shadow: 2px 2px 0px rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .btn:active { transform: translate(1px, 1px); box-shadow: none; }
        .btn-primary { background: #2ecc71; color: white; border-color: #27ae60; }
        .btn-danger { background: #e74c3c; color: white; border-color: #c0392b; }

        /* --- VIEWER --- */
        /* Dit is de container die beweegt. Alles erin beweegt mee. */
        #score-container { 
            position: relative; /* Cruciaal voor absolute children */
            margin-top: 140px; /* Ruimte voor header */
            display: flex; flex-direction: column; align-items: center; 
            min-height: 100vh;
            transition: margin-top 0.4s ease; /* Soepele beweging bij start */
            cursor: crosshair; /* Visuele indicatie voor precisie */
        }
        
        canvas { 
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); margin-bottom: 20px; 
            max-width: 96%; height: auto; background: white; pointer-events: none; 
        }

        /* --- OVERLAYS (Relatief aan score-container) --- */
        #cursor-line {
            position: absolute; left: 0; width: 100%; height: 4px;
            background: var(--accent); z-index: 500; display: none; pointer-events: none;
            box-shadow: 0 0 10px var(--accent);
        }

        #info-bubble {
            position: absolute; left: 50%; bottom: -35px; transform: translateX(-50%);
            background: var(--ink); color: white; padding: 4px 12px;
            font-size: 12px; font-weight: bold; border-radius: 12px;
            white-space: nowrap; pointer-events: none;
        }

        .sys-box { position: absolute; left: 0; width: 100%; border: 2px solid blue; pointer-events: none; opacity: 0.5; }
        .meas-box { position: absolute; top: 0; height: 100%; border-right: 1px solid blue; pointer-events: none; }
        .meas-box.active { background: var(--highlight); opacity: 1; }

        /* --- FAB BUTTONS --- */
        .fab {
            position: fixed; bottom: 30px; width: 60px; height: 60px;
            border-radius: 50%; background: var(--ink); color: white;
            display: none; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; z-index: 2000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 2px solid white;
        }
        #stop-fab { right: 20px; background: var(--accent); }
        #pause-fab { left: 20px; background: #f1c40f; color: black; }

        /* --- MODES --- */
        /* Als we spelen, schuiven we de header weg en verminderen we de margin */
        body.mode-play #ui-bar { transform: translateY(-100%); }
        body.mode-play #score-container { margin-top: 20px; } 
        body.mode-clean .sys-box, body.mode-clean .meas-box { opacity: 0 !important; }
    </style>
</head>
<body>

<nav id="ui-bar">
    <div style="background:var(--ink); color:white; text-align:center; padding:4px; font-size:10px; letter-spacing:1px;" id="status-text">Klaar voor start</div>
    <div class="toolbar">
        <div class="group">
            <span class="label">Bibliotheek</span>
            <div style="display:flex; gap:5px;">
                <select id="lib-select" style="width:100px;"><option value="">-- Laden --</option></select>
                <button id="btn-del" class="btn btn-danger" style="padding:5px 8px;">X</button>
            </div>
        </div>
        <div class="group">
            <span class="label">PDF</span>
            <input type="file" id="file-upload" accept="application/pdf" style="width:110px;">
        </div>
        <div class="group">
            <span class="label">BPM / Maat</span>
            <div style="display:flex; gap:5px;">
                <input type="number" id="inp-bpm" value="120" style="width:40px;">
                <select id="inp-ts"><option value="4">4/4</option><option value="3">3/4</option><option value="2">2/4</option><option value="6">6/8</option></select>
            </div>
        </div>
        <div class="group">
            <span class="label">Acties</span>
            <div style="display:flex; gap:5px;">
                <button id="btn-undo" class="btn">Undo</button>
                <button id="btn-ok" class="btn" style="display:none; border-color:blue; color:blue;">OK</button>
                <button id="btn-save" class="btn" style="background:#3498db; color:white;">Save</button>
                <button id="btn-play" class="btn btn-primary">Start</button>
            </div>
        </div>
        <div class="group">
            <span class="label">Opties</span>
            <div style="display:flex; gap:5px;">
                <select id="inp-click"><option value="on">Klik Aan</option><option value="off">Klik Uit</option></select>
                <select id="inp-view"><option value="guide">Guide</option><option value="clean">Clean</option></select>
            </div>
        </div>
    </div>
</nav>

<div id="score-container">
    <div id="cursor-line"><div id="info-bubble"></div></div>
</div>

<div id="pause-fab" class="fab">II</div>
<div id="stop-fab" class="fab">STOP</div>

<script>
    // --- DATABASE ---
    const DB = {
        name: "ConductorProDB_v72", // Nieuwe naam voor schone start
        version: 1,
        db: null,
        async init() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open(this.name, this.version);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('scores')) db.createObjectStore('scores', { keyPath: 'name' });
                };
                req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
                req.onerror = (e) => reject(e);
            });
        },
        async save(name, pdfBlob, data) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction('scores', 'readwrite');
                tx.objectStore('scores').put({ name, pdfBlob, data, timestamp: Date.now() }).onsuccess = () => resolve();
                tx.onerror = (e) => reject(e);
            });
        },
        async load(name) {
            return new Promise((resolve, reject) => {
                const tx = this.db.transaction('scores', 'readonly');
                tx.objectStore('scores').get(name).onsuccess = (e) => resolve(e.target.result);
                tx.onerror = (e) => reject(e);
            });
        },
        async getAllKeys() {
            return new Promise((resolve) => {
                const keys = [];
                const tx = this.db.transaction('scores', 'readonly');
                tx.objectStore('scores').openCursor().onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) { keys.push(cursor.key); cursor.continue(); } else resolve(keys);
                };
            });
        },
        async delete(name) {
            return new Promise((resolve) => {
                const tx = this.db.transaction('scores', 'readwrite');
                tx.objectStore('scores').delete(name).onsuccess = () => resolve();
            });
        }
    };

    // --- AUDIO ---
    const AudioEngine = {
        ctx: null,
        init() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
        resume() { if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
        beep(isDownbeat) {
            if (!this.ctx) this.init();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain); gain.connect(this.ctx.destination);
            osc.frequency.value = isDownbeat ? 1000 : 600;
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.1);
            osc.start(); osc.stop(this.ctx.currentTime + 0.1);
        }
    };

    // --- APP ---
    const App = {
        pdfDoc: null, currentPdfBlob: null, systems: [], tempSys: null,
        state: 'IDLE', isRunning: false, isPaused: false,
        ui: {
            container: document.getElementById('score-container'),
            status: document.getElementById('status-text'),
            libSelect: document.getElementById('lib-select'),
            line: document.getElementById('cursor-line'),
            bubble: document.getElementById('info-bubble')
        },

        async start() {
            await DB.init();
            this.refreshLibrary();
            this.setupEvents();
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        },

        setupEvents() {
            document.getElementById('file-upload').onchange = (e) => this.handleUpload(e);
            document.getElementById('btn-play').onclick = () => this.play();
            document.getElementById('stop-fab').onclick = () => this.stop();
            document.getElementById('pause-fab').onclick = () => { this.isPaused = !this.isPaused; };
            document.getElementById('btn-save').onclick = () => this.handleSave();
            document.getElementById('lib-select').onchange = (e) => this.handleLoad(e.target.value);
            document.getElementById('btn-del').onclick = () => this.handleDelete();
            
            // EDITOR CLICK HANDLER (DE PRECISIE FIX)
            this.ui.container.onmousedown = (e) => {
                if (this.isRunning) return;
                
                // 1. Haal de 'Bounding Rect' van de container op.
                // Dit geeft ons de exacte positie van de container op het scherm.
                const rect = this.ui.container.getBoundingClientRect();
                
                // 2. Bereken Y relatief aan de BOVENKANT van de container.
                // e.clientY is muis op scherm. rect.top is bovenkant container op scherm.
                // Het verschil is de exacte pixel in de container, ongeacht scroll of margin.
                const relativeY = e.clientY - rect.top;
                const relativeX = e.clientX - rect.left;

                // 3. Zet om naar percentage voor responsive scaling
                const yPct = (relativeY / rect.height) * 100;
                const xPct = (relativeX / rect.width) * 100;

                this.onEditorClick(yPct, xPct);
            };

            document.getElementById('btn-ok').onclick = () => this.commitSystem();
            document.getElementById('btn-undo').onclick = () => this.undo();
        },

        setStatus(msg) { this.ui.status.innerText = msg; },

        async handleUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            this.currentPdfBlob = file;
            await this.renderPDF(file);
            this.systems = []; this.clearOverlays();
        },

        async renderPDF(blob) {
            this.setStatus("Renderen...");
            const arrayBuffer = await blob.arrayBuffer();
            this.pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
            this.ui.container.querySelectorAll('canvas').forEach(c => c.remove());
            
            for (let i = 1; i <= this.pdfDoc.numPages; i++) {
                const page = await this.pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                this.ui.container.appendChild(canvas);
            }
            this.state = 'MARKING_TOP'; this.setStatus("Klik BOVENKANT regel");
        },

        onEditorClick(yPct, xPct) {
            if (this.state === 'MARKING_TOP') {
                this.tempSys = { top: yPct, bottom: 0, measures: [], ui: [] };
                this.state = 'MARKING_BOTTOM'; this.setStatus("Klik ONDERKANT regel");
            } 
            else if (this.state === 'MARKING_BOTTOM') {
                this.tempSys.bottom = yPct;
                this.drawSystemBox(this.tempSys);
                this.state = 'MARKING_MEASURES';
                this.setStatus("Klik maatstrepen. Druk OK.");
                document.getElementById('btn-ok').style.display = 'inline-block';
            }
            else if (this.state === 'MARKING_MEASURES') {
                this.tempSys.measures.push(xPct);
                this.drawMeasureLine(this.tempSys, xPct);
            }
        },

        drawSystemBox(sys) {
            const div = document.createElement('div'); div.className = 'sys-box';
            div.style.top = sys.top + '%'; div.style.height = (sys.bottom - sys.top) + '%';
            this.ui.container.appendChild(div); sys.ui.push(div);
        },

        drawMeasureLine(sys, x) {
            const div = document.createElement('div'); div.className = 'meas-box';
            // Visueel truukje: We tekenen de streep relative aan de container, 
            // maar in play mode vullen we de ruimte ertussen.
            // Voor nu: simpele verticale lijn op X positie.
            div.style.left = x + '%'; div.style.borderRight = "2px solid blue";
            div.style.top = sys.top + '%'; div.style.height = (sys.bottom - sys.top) + '%';
            this.ui.container.appendChild(div); sys.ui.push(div);
        },

        commitSystem() {
            this.tempSys.measures.sort((a,b) => a - b);
            this.systems.push(this.tempSys);
            this.tempSys = null;
            this.state = 'MARKING_TOP'; this.setStatus("Regel opgeslagen.");
            document.getElementById('btn-ok').style.display = 'none';
        },

        undo() {
            if (this.state === 'MARKING_MEASURES' && this.tempSys.measures.length > 0) {
                this.tempSys.measures.pop();
                const el = this.tempSys.ui.pop(); if(el) el.remove();
            } else if (this.systems.length > 0) {
                const sys = this.systems.pop();
                sys.ui.forEach(el => el.remove());
                this.state = 'MARKING_TOP'; this.setStatus("Regel verwijderd.");
            }
        },

        clearOverlays() { document.querySelectorAll('.sys-box, .meas-box').forEach(e => e.remove()); },

        // --- PLAYBACK ---
        async play() {
            if (!this.systems.length) return alert("Geen data!");
            this.isRunning = true; this.isPaused = false;
            AudioEngine.resume();
            
            document.body.classList.add('mode-play');
            const viewMode = document.getElementById('inp-view').value;
            if(viewMode === 'clean') document.body.classList.add('mode-clean');
            
            this.ui.line.style.display = 'block';
            document.getElementById('stop-fab').style.display = 'flex';
            document.getElementById('pause-fab').style.display = 'flex';

            const bpm = parseInt(document.getElementById('inp-bpm').value);
            const ts = parseInt(document.getElementById('inp-ts').value);
            const useClick = document.getElementById('inp-click').value === 'on';

            // Teken 'echte' maatblokken voor highlighting (verborgen tot play)
            this.preparePlaybackVisuals();

            for (let i = 0; i < this.systems.length; i++) {
                if (!this.isRunning) break;
                await this.playSystemSequence(this.systems[i], i, bpm, ts, useClick);
            }
            this.stop();
        },

        preparePlaybackVisuals() {
            // Converteer lijntjes naar vlakken voor highlighting
            this.clearOverlays(); // Ruim editor lijnen op
            this.systems.forEach(sys => {
                // Teken container box
                const sysDiv = document.createElement('div'); sysDiv.className = 'sys-box';
                sysDiv.style.top = sys.top + '%'; sysDiv.style.height = (sys.bottom - sys.top) + '%';
                this.ui.container.appendChild(sysDiv);
                
                // Teken maatvlakken
                const coords = [0, ...sys.measures, 100];
                sys.playbackBlocks = [];
                for(let i=0; i<coords.length-1; i++) {
                    const blk = document.createElement('div'); blk.className = 'meas-box';
                    blk.style.left = coords[i] + '%'; 
                    blk.style.width = (coords[i+1] - coords[i]) + '%';
                    // Voeg toe aan sysDiv zodat ze relatief zijn aan de regel
                    sysDiv.appendChild(blk);
                    sys.playbackBlocks.push(blk);
                }
            });
        },

        playSystemSequence(sys, idx, bpm, ts, useClick) {
            return new Promise(resolve => {
                const measureCount = sys.playbackBlocks.length;
                const totalBeats = measureCount * ts;
                const totalDuration = (totalBeats / bpm) * 60;
                
                const glideRatio = 0.15; // 15% glide
                const isLastSys = idx === this.systems.length - 1;
                const scanTime = isLastSys ? totalDuration : totalDuration * (1 - glideRatio);
                const glideTime = isLastSys ? 0 : totalDuration * glideRatio;

                let start = performance.now();
                let lastBeatIdx = -1;

                const tick = (now) => {
                    if (!this.isRunning) return resolve();
                    if (this.isPaused) { start += (performance.now() - now); requestAnimationFrame(tick); return; }

                    const elapsed = (now - start) / 1000;
                    const pct = Math.min(elapsed / totalDuration, 1);
                    
                    // BEATS
                    const currentBeatTotal = Math.floor(pct * totalBeats);
                    if (currentBeatTotal !== lastBeatIdx && currentBeatTotal < totalBeats) {
                        const bInM = (currentBeatTotal % ts) + 1;
                        const mNum = Math.floor(currentBeatTotal / ts) + 1;
                        this.ui.bubble.innerText = `M${mNum} . ${bInM}`;
                        if (useClick) AudioEngine.beep(bInM === 1);
                        lastBeatIdx = currentBeatTotal;
                    }

                    // HIGHLIGHT
                    const activeMeasureIdx = Math.floor(currentBeatTotal / ts);
                    sys.playbackBlocks.forEach((b, k) => {
                        if (k === activeMeasureIdx) b.classList.add('active');
                        else b.classList.remove('active');
                    });

                    // LIJN BEWEGING
                    let y = 0;
                    if (elapsed <= scanTime) {
                        const sysPct = elapsed / scanTime;
                        y = sys.top + (sysPct * (sys.bottom - sys.top));
                    } else {
                        const nextSys = this.systems[idx + 1];
                        const glidePct = (elapsed - scanTime) / glideTime;
                        y = sys.bottom + (glidePct * (nextSys.top - sys.bottom));
                    }
                    this.ui.line.style.top = y + '%';

                    // SCROLL FIX: Gebruik line.getBoundingClientRect() om te checken of hij te laag komt
                    const lineRect = this.ui.line.getBoundingClientRect();
                    const threshold = window.innerHeight * 0.60;
                    if (lineRect.top > threshold) {
                         window.scrollBy({ top: lineRect.top - (window.innerHeight * 0.40), behavior: 'smooth' });
                    }

                    if (elapsed < totalDuration) requestAnimationFrame(tick);
                    else resolve();
                };
                requestAnimationFrame(tick);
            });
        },

        stop() {
            this.isRunning = false;
            document.body.classList.remove('mode-play', 'mode-clean');
            this.ui.line.style.display = 'none';
            document.getElementById('stop-fab').style.display = 'none';
            document.getElementById('pause-fab').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            // Herstel editor view (optioneel, of reload om schoon te beginnen)
        },

        async handleSave() {
            if (!this.currentPdfBlob || !this.systems.length) return alert("Niets om op te slaan.");
            const name = prompt("Naam:");
            if (!name) return;
            const data = {
                bpm: document.getElementById('inp-bpm').value,
                ts: document.getElementById('inp-ts').value,
                systems: this.systems.map(s => ({ top: s.top, bottom: s.bottom, measures: s.measures }))
            };
            try { await DB.save(name, this.currentPdfBlob, data); alert("Opgeslagen!"); this.refreshLibrary(); } 
            catch (e) { alert("Fout: " + e.message); }
        },

        async refreshLibrary() {
            const keys = await DB.getAllKeys();
            const sel = this.ui.libSelect; sel.innerHTML = '<option value="">-- Laden --</option>';
            keys.forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.innerText = k; sel.appendChild(opt); });
        },

        async handleLoad(name) {
            if (!name) return;
            try {
                const record = await DB.load(name);
                this.currentPdfBlob = record.pdfBlob;
                await this.renderPDF(record.pdfBlob);
                this.systems = []; // Clear old
                
                // Restore logic
                record.data.systems.forEach(s => {
                    this.tempSys = { top: s.top, bottom: s.bottom, measures: s.measures, ui: [] };
                    this.drawSystemBox(this.tempSys);
                    // Re-draw measures visually
                    s.measures.forEach(mx => this.drawMeasureLine(this.tempSys, mx));
                    this.commitSystem();
                });
                
                document.getElementById('inp-bpm').value = record.data.bpm;
                document.getElementById('inp-ts').value = record.data.ts;
                this.setStatus("Geladen: " + name);
            } catch (e) { alert("Laad fout: " + e); }
        },
        
        async handleDelete() {
             const name = this.ui.libSelect.value;
             if(name && confirm("Wissen?")) { await DB.delete(name); this.refreshLibrary(); }
        }
    };

    App.start();
</script>
</body>
                    </html>
