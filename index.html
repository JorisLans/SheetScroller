<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Conductor App v68 - Metronome Restored</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --ink: #121212; --paper: #f8f9fa; --white: #ffffff;
            --border-width: 3px;
            --measure-light: rgba(0, 0, 0, 0.05); 
            --measure-dark: rgba(0, 0, 0, 0.15); 
            --active-highlight: rgba(0, 0, 0, 0.35);
            --accent: #e74c3c;
        }

        body { font-family: 'Georgia', serif; margin: 0; background: #e9ecef; color: var(--ink); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }

        #master-header { 
            position: fixed; top: 0; width: 100%; z-index: 100000;
            background: rgba(255, 255, 255, 0.98); border-bottom: var(--border-width) solid var(--ink);
            transition: transform 0.5s ease;
        }

        .status-bar { background: var(--ink); color: var(--white); text-align: center; padding: 6px; font-weight: bold; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .nav-container { display: flex; flex-wrap: wrap; gap: 15px; padding: 12px; align-items: flex-end; max-width: 1400px; margin: 0 auto; justify-content: space-around; }

        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .input-label { font-size: 9px; font-weight: 900; text-transform: uppercase; color: #888; }
        
        .btn { 
            padding: 8px 15px; border: var(--border-width) solid var(--ink); border-radius: 0px; 
            background: var(--white); color: var(--ink); cursor: pointer; 
            font-weight: 900; font-family: sans-serif; text-transform: uppercase; font-size: 10px;
            box-shadow: 4px 4px 0px var(--ink); transition: all 0.1s;
        }
        .btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--ink); }
        .btn-danger { background: var(--accent); color: white; border-color: #c0392b; }

        #content-wrapper { padding-top: 170px; transition: padding 0.5s ease; }
        body.is-playing #content-wrapper { padding-top: 40px; }

        #viewer-container { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; }
        canvas { box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 30px; width: 98% !important; max-width: 1200px; height: auto !important; background: white; }

        #scanning-line { position: absolute; left: 0; width: 100%; height: 4px; background: var(--accent); z-index: 110000; display: none; pointer-events: none; box-shadow: 0 0 12px rgba(231, 76, 60, 0.6); }
        #beat-bubble { position: absolute; left: 50%; bottom: -45px; transform: translateX(-50%); background: var(--ink); color: #fff; padding: 6px 16px; font-size: 13px; font-weight: 900; border: 2px solid #fff; white-space: nowrap; border-radius: 4px; }

        .system-box { position: absolute; left: 0; width: 100%; border: 2px solid var(--ink); pointer-events: none; z-index: 1000; box-sizing: border-box; }
        .measure-block { position: absolute; height: 100%; top: 0; z-index: 500; pointer-events: none; }
        .label-tag { position: absolute; right: 10px; background: var(--white); color: var(--ink); border: 2px solid var(--ink); padding: 4px 8px; font-weight: 900; font-size: 10px; z-index: 2000; transform: translateY(-50%); }

        .orb-btn { position: fixed; bottom: 30px; width: 65px; height: 65px; border-radius: 50%; border: 4px solid var(--ink); display: none; align-items: center; justify-content: center; cursor: pointer; z-index: 120000; font-weight: 900; font-size: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #pause-btn { left: 30px; background: var(--white); color: var(--ink); }
        #stop-btn { right: 30px; background: var(--ink); color: var(--white); }

        body.play-guide .measure-block.active { background: var(--active-highlight) !important; }
        body.play-clean .system-box, body.play-clean .label-tag, body.play-clean .measure-block { opacity: 0 !important; }
    </style>
</head>
<body>

<header id="master-header">
    <div class="status-bar" id="step-info">Conductor v68 - Metronome Fix</div>
    <div class="nav-container">
        <div class="control-group">
            <span class="input-label">Bibliotheek</span>
            <div style="display:flex; gap:4px;">
                <select id="library-select" style="padding:4px;"><option value="">-- Scores --</option></select>
                <button id="del-btn" class="btn btn-danger" style="padding:4px 8px;">X</button>
            </div>
        </div>
        <div class="control-group">
            <span class="input-label">PDF / BPM / Maat</span>
            <div style="display:flex; gap:4px; align-items:center;">
                <input type="file" id="upload-pdf" style="font-size: 9px; width: 100px;">
                <input type="number" id="bpm-input" value="120" style="width:35px; padding:4px;">
                <select id="ts-input" style="padding:4px;"><option value="4">4/4</option><option value="3">3/4</option><option value="2">2/4</option><option value="6">6/8</option></select>
            </div>
        </div>
        <div class="control-group">
            <span class="input-label">Mode & Glide</span>
            <div style="display:flex; gap:8px; align-items:center;">
                <select id="play-mode" style="padding:4px;"><option value="guide">Guide</option><option value="clean">Clean</option></select>
                <input type="range" id="glide-input" min="0" max="40" value="15" style="width: 45px;">
            </div>
        </div>
        <div style="display:flex; gap:6px;">
            <button id="save-btn" class="btn" style="background:#3498db; color:white;">SAVE</button>
            <button id="undo-btn" class="btn">Undo</button>
            <button id="confirm-btn" class="btn" style="display:none; background:var(--ink); color:#fff;">OK (<span id="m-count">1</span>)</button>
            <button id="start-btn" class="btn" style="background:#2ecc71;">START</button>
        </div>
    </div>
</header>

<div id="content-wrapper">
    <div id="viewer-container">
        <div id="scanning-line"><div id="beat-bubble">M 1 | B 1</div></div>
    </div>
</div>

<div id="pause-btn" class="orb-btn">PAUZE</div>
<div id="stop-btn" class="orb-btn">STOP</div>

<script>
    const DB_NAME = "ConductorAppDB_v68";
    const DB_VERSION = 1;
    let db;

    const Engine = {
        pdf: null, pdfData: null, systems: [], currentSystem: null,
        state: 'IDLE', isRunning: false, isPaused: false,
        audioCtx: null, visualHistory: [], lastBeat: -1,

        async init() {
            await this.initDB();
            this.bindEvents();
            this.refreshLibrary();
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        },

        initDB() {
            return new Promise((resolve) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    db = e.target.result;
                    db.createObjectStore("scores", { keyPath: "name" });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(); };
            });
        },

        bindEvents() {
            document.getElementById('upload-pdf').onchange = (e) => this.handleFileUpload(e);
            document.getElementById('viewer-container').onmousedown = (e) => this.handleMarking(e);
            document.getElementById('confirm-btn').onclick = () => this.confirmSystem();
            document.getElementById('undo-btn').onclick = () => this.undo();
            document.getElementById('start-btn').onclick = () => this.start();
            document.getElementById('stop-btn').onclick = () => this.stop();
            document.getElementById('pause-btn').onclick = () => this.togglePause();
            document.getElementById('save-btn').onclick = () => this.saveToApp();
            document.getElementById('del-btn').onclick = () => this.deleteFromApp();
            document.getElementById('library-select').onchange = (e) => this.loadFromApp(e.target.value);
        },

        async handleFileUpload(e) {
            const file = e.target.files[0]; if (!file) return;
            this.pdfData = await file.arrayBuffer();
            this.loadPDF(this.pdfData);
        },

        async loadPDF(data) {
            this.updateStatus("Rendering PDF...");
            this.pdf = await pdfjsLib.getDocument({ data: data }).promise;
            const container = document.getElementById('viewer-container');
            container.querySelectorAll('canvas').forEach(c => c.remove());
            for (let i = 1; i <= this.pdf.numPages; i++) {
                const page = await this.pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.2 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                container.appendChild(canvas);
            }
            this.state = 'TOP'; this.updateStatus("Klik BOVENKANT");
        },

        handleMarking(e) {
            if (this.state === 'IDLE' || this.isRunning) return;
            const container = document.getElementById('viewer-container');
            const rect = container.getBoundingClientRect();
            const y = ((e.pageY - (rect.top + window.scrollY)) / container.scrollHeight) * 100;
            const x = ((e.pageX - rect.left) / rect.width) * 100;

            if (this.state === 'TOP') {
                this.currentSystem = { top: y, bottom: 0, measures: [], blocks: [] };
                this.state = 'BOTTOM'; this.updateStatus("Klik ONDERKANT");
            } else if (this.state === 'BOTTOM') {
                this.currentSystem.bottom = y;
                this.createUI(y);
                this.state = 'MEASURES';
                document.getElementById('confirm-btn').style.display = 'inline-block';
                this.refreshLabel();
            } else if (this.state === 'MEASURES') {
                this.addMeasure(x);
            }
        },

        createUI(by) {
            const c = document.getElementById('viewer-container');
            const box = document.createElement('div'); box.className = 'system-box';
            box.style.top = this.currentSystem.top + '%'; 
            box.style.height = (by - this.currentSystem.top) + '%';
            const lb = document.createElement('div'); lb.className = 'label-tag';
            lb.style.top = ((this.currentSystem.top + by) / 2) + '%';
            c.appendChild(box); c.appendChild(lb);
            this.currentSystem.boxEl = box; this.currentSystem.labelEl = lb;
            this.visualHistory.push({ type: 'BOX', el: box, lb: lb });
        },

        addMeasure(x) {
            const lx = this.currentSystem.measures.length > 0 ? this.currentSystem.measures[this.currentSystem.measures.length - 1] : 0;
            const b = document.createElement('div'); b.className = 'measure-block';
            b.style.left = lx + '%'; b.style.width = (x - lx) + '%';
            b.style.background = (this.currentSystem.measures.length % 2 === 1) ? 'var(--measure-dark)' : 'var(--measure-light)';
            this.currentSystem.boxEl.appendChild(b);
            this.currentSystem.blocks.push(b);
            this.currentSystem.measures.push(x);
            this.visualHistory.push({ type: 'MEASURE', el: b });
            this.refreshLabel();
        },

        confirmSystem() {
            const lx = this.currentSystem.measures.length > 0 ? this.currentSystem.measures[this.currentSystem.measures.length - 1] : 0;
            const fb = document.createElement('div'); fb.className = 'measure-block';
            fb.style.left = lx + '%'; fb.style.width = (100 - lx) + '%';
            fb.style.background = (this.currentSystem.measures.length % 2 === 1) ? 'var(--measure-dark)' : 'var(--measure-light)';
            this.currentSystem.boxEl.appendChild(fb);
            this.currentSystem.blocks.push(fb);
            this.systems.push(this.currentSystem);
            this.currentSystem = null; this.visualHistory = []; this.state = 'TOP';
            document.getElementById('confirm-btn').style.display = 'none';
        },

        undo() {
            if (!this.visualHistory.length) return;
            const item = this.visualHistory.pop();
            if (item.type === 'MEASURE') {
                item.el.remove(); this.currentSystem.measures.pop(); this.currentSystem.blocks.pop();
            } else {
                item.el.remove(); item.lb.remove(); this.currentSystem = null; this.state = 'TOP';
                document.getElementById('confirm-btn').style.display = 'none';
            }
            this.refreshLabel();
        },

        refreshLabel() {
            if (!this.currentSystem) return;
            const mCount = this.currentSystem.measures.length + 1;
            const ts = parseInt(document.getElementById('ts-input').value);
            document.getElementById('m-count').innerText = mCount;
            this.currentSystem.labelEl.innerText = `R${this.systems.length + 1}: ${mCount}M | ${mCount * ts}B`;
        },

        saveToApp() {
            if (!this.systems.length || !this.pdfData) return alert("Upload PDF en markeer eerst!");
            const name = prompt("Naam van deze partituur:");
            if (!name) return;
            const transaction = db.transaction(["scores"], "readwrite");
            const score = {
                name: name,
                pdfData: this.pdfData,
                bpm: document.getElementById('bpm-input').value,
                ts: document.getElementById('ts-input').value,
                glide: document.getElementById('glide-input').value,
                systems: this.systems.map(s => ({ top: s.top, bottom: s.bottom, measures: s.measures }))
            };
            transaction.objectStore("scores").put(score);
            transaction.oncomplete = () => { alert("Opgeslagen!"); this.refreshLibrary(); };
        },

        deleteFromApp() {
            const name = document.getElementById('library-select').value;
            if (!name || !confirm(`Weet je zeker dat je '${name}' wilt verwijderen?`)) return;
            const transaction = db.transaction(["scores"], "readwrite");
            transaction.objectStore("scores").delete(name);
            transaction.oncomplete = () => { location.reload(); };
        },

        refreshLibrary() {
            const select = document.getElementById('library-select');
            select.innerHTML = '<option value="">-- Scores --</option>';
            const transaction = db.transaction(["scores"], "readonly");
            transaction.objectStore("scores").openCursor().onsuccess = (e) => {
                const cursor = e.target.result;
                if (cursor) {
                    const opt = document.createElement('option');
                    opt.value = cursor.key; opt.innerText = cursor.key;
                    select.appendChild(opt);
                    cursor.continue();
                }
            };
        },

        async loadFromApp(name) {
            if (!name) return;
            const transaction = db.transaction(["scores"], "readonly");
            transaction.objectStore("scores").get(name).onsuccess = async (e) => {
                const data = e.target.result;
                this.pdfData = data.pdfData;
                await this.loadPDF(this.pdfData);
                document.getElementById('bpm-input').value = data.bpm;
                document.getElementById('ts-input').value = data.ts;
                document.getElementById('glide-input').value = data.glide || 15;
                this.systems = [];
                data.systems.forEach(s => {
                    this.currentSystem = { top: s.top, bottom: s.bottom, measures: [], blocks: [] };
                    this.createUI(s.bottom);
                    s.measures.forEach(m => this.addMeasure(m));
                    this.confirmSystem();
                });
            };
        },

        async start() {
            if (!this.systems.length) return;
            this.isRunning = true; this.isPaused = false;
            this.lastBeat = -1; // Reset beat tracking
            const mode = document.getElementById('play-mode').value;
            document.body.classList.add('is-playing', 'play-' + mode);
            document.getElementById('master-header').style.transform = 'translateY(-100%)';
            document.getElementById('pause-btn').style.display = 'flex';
            document.getElementById('stop-btn').style.display = 'flex';
            document.getElementById('scanning-line').style.display = 'block';

            const bpm = parseInt(document.getElementById('bpm-input').value);
            const ts = parseInt(document.getElementById('ts-input').value);
            const glide = parseInt(document.getElementById('glide-input').value) / 100;

            // Audio initialisatie
            if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (this.audioCtx.state === 'suspended') await this.audioCtx.resume();

            for (let i = 0; i < this.systems.length; i++) {
                if (!this.isRunning) break;
                await this.playSys(this.systems[i], i, bpm, ts, glide);
            }
            this.stop();
        },

        playSys(sys, idx, bpm, ts, gF) {
            return new Promise(res => {
                const nM = sys.blocks.length; const tD = (nM * ts / bpm) * 60;
                const trD = (idx < this.systems.length - 1) ? tD * gF : 0;
                const sD = tD - trD; let startTime = performance.now();
                const line = document.getElementById('scanning-line');

                const tick = (now) => {
                    if (!this.isRunning) return res();
                    if (this.isPaused) { startTime += (performance.now() - now); requestAnimationFrame(tick); return; }
                    const el = (now - startTime) / 1000;
                    const pr = Math.min(el / tD, 0.999);
                    const totalBeats = nM * ts;
                    const currentTotalBeat = Math.floor(pr * totalBeats);

                    // METRONOOM & BUBBLE UPDATE
                    if (currentTotalBeat !== this.lastBeat) {
                        const beatInMeasure = (currentTotalBeat % ts);
                        this.click(beatInMeasure === 0); // Accent op de eerste tel
                        this.lastBeat = currentTotalBeat;
                        document.getElementById('beat-bubble').innerText = `M ${Math.floor(currentTotalBeat/ts)+1} | B ${beatInMeasure+1}`;
                    }

                    // BLOK HIGHLIGHT
                    sys.blocks.forEach((b, k) => b.classList.toggle('active', k === Math.floor(currentTotalBeat/ts)));

                    // LIJN BEWEGING
                    let y = (el <= sD) ? sys.top + (el * ((sys.bottom - sys.top) / sD)) : sys.bottom + (this.systems[idx+1].top - sys.bottom) * ((el - sD) / trD);
                    line.style.top = y + '%';

                    // AUTO-SCROLL
                    const lineRect = line.getBoundingClientRect();
                    const targetPos = window.innerHeight * 0.40;
                    if (lineRect.top > targetPos) window.scrollBy(0, lineRect.top - targetPos);

                    if (el < tD) requestAnimationFrame(tick); else res();
                };
                requestAnimationFrame(tick);
            });
        },

        click(isFirstBeat) {
            const o = this.audioCtx.createOscillator();
            const g = this.audioCtx.createGain();
            o.connect(g); g.connect(this.audioCtx.destination);
            o.frequency.value = isFirstBeat ? 1200 : 800; // Hoog voor tel 1, lager voor de rest
            g.gain.setValueAtTime(0.15, this.audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.06);
            o.start(); o.stop(this.audioCtx.currentTime + 0.06);
        },

        togglePause() { this.isPaused = !this.isPaused; document.getElementById('pause-btn').innerText = this.isPaused ? "GA" : "PAUZE"; },
        stop() { this.isRunning = false; document.body.classList.remove('is-playing', 'play-guide', 'play-clean'); document.getElementById('master-header').style.transform = 'translateY(0)'; document.getElementById('pause-btn').style.display = 'none'; document.getElementById('stop-btn').style.display = 'none'; document.getElementById('scanning-line').style.display = 'none'; window.scrollTo(0,0); },
        updateStatus(m) { document.getElementById('step-info').innerText = m; }
    };
    Engine.init();
</script>
</body>
</html>
