<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Conductor v57 - Universal Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --ink: #121212; --paper: #f8f9fa; --white: #ffffff;
            --border-width: 3px;
            --m1: rgba(0, 0, 0, 0.05); --m2: rgba(0, 0, 0, 0.12);
            --m3: rgba(0, 0, 0, 0.08); --m4: rgba(0, 0, 0, 0.15);
        }

        body { 
            font-family: 'Georgia', serif; margin: 0; background: #e9ecef; 
            color: var(--ink); overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }

        /* --- RESPONSIVE HEADER --- */
        #master-header { 
            position: fixed; top: 0; width: 100%; z-index: 100000;
            background: rgba(255, 255, 255, 0.98);
            border-bottom: var(--border-width) solid var(--ink);
        }

        .status-bar { 
            background: var(--ink); color: var(--white); 
            text-align: center; padding: 6px; font-weight: bold; 
            font-size: 9px; text-transform: uppercase; letter-spacing: 1.5px;
        }

        .nav-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px; padding: 10px; align-items: end; max-width: 1400px; margin: 0 auto;
        }

        /* Voor laptop schermen maken we het weer een rij */
        @media (min-width: 1024px) {
            .nav-container { display: flex; justify-content: space-between; padding: 15px 30px; }
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .row-group { display: flex; align-items: center; gap: 10px; }

        .input-label { font-size: 10px; font-weight: 900; text-transform: uppercase; color: #666; }
        
        .btn { 
            padding: 10px 15px; border: var(--border-width) solid var(--ink); border-radius: 0px; 
            background: var(--white); color: var(--ink); cursor: pointer; 
            font-weight: 900; font-family: sans-serif; text-transform: uppercase; font-size: 10px;
            box-shadow: 3px 3px 0px var(--ink);
        }

        /* --- PDF VIEWER --- */
        #content-wrapper { padding-top: 180px; transition: padding 0.3s; }
        @media (min-width: 1024px) { #content-wrapper { padding-top: 130px; } }

        #viewer-container { position: relative; width: 100%; display: flex; flex-direction: column; align-items: center; }
        canvas { box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 20px; width: 95% !important; height: auto !important; }

        /* --- MARKERS & OVERLAYS --- */
        #scanning-line { position: absolute; left: 0; width: 100%; height: 5px; background: #000; z-index: 99999; display: none; pointer-events: none; }
        #beat-bubble {
            position: absolute; left: 50%; bottom: -35px; transform: translateX(-50%);
            background: var(--ink); color: #fff; padding: 5px 12px; font-size: 12px; font-weight: 900; border: 2px solid #fff; white-space: nowrap;
        }

        .system-box { position: absolute; left: 0; width: 100%; border: 4px solid var(--ink); pointer-events: none; z-index: 10; opacity: 0.7; }
        .measure-block { position: absolute; pointer-events: none; z-index: 5; }
        .label-tag { 
            position: absolute; right: 10px; background: var(--white); color: var(--ink); 
            border: 2px solid var(--ink); padding: 5px; font-weight: 900; font-size: 10px; z-index: 20; transform: translateY(-50%);
        }

        /* PERFORMANCE UI */
        #performance-overlay { 
            position: fixed; bottom: 20px; right: 20px; left: 20px; z-index: 110000; 
            display: none; gap: 10px; background: var(--white); padding: 15px; 
            border: 3px solid var(--ink); box-shadow: 5px 5px 0px rgba(0,0,0,0.2);
            justify-content: center;
        }
        @media (min-width: 768px) { #performance-overlay { left: auto; width: auto; } }

        body.play-clean #scanning-line, body.play-clean .system-box, body.play-clean .label-tag, body.play-clean .measure-block { opacity: 0 !important; }
        body.play-guide .measure-block.active { background: #000 !important; opacity: 0.3 !important; }
    </style>
</head>
<body id="main-body">

<header id="master-header">
    <div class="status-bar" id="step-info">Universal Conductor Ready</div>
    <div class="nav-container">
        <div class="control-group">
            <span class="input-label">Score</span>
            <input type="file" id="upload-pdf" style="font-size: 10px; width: 140px;">
        </div>
        
        <div class="row-group">
            <div class="control-group">
                <span class="input-label">BPM</span>
                <input type="number" id="bpm-input" value="120" style="width:50px;">
            </div>
            <div class="control-group">
                <span class="input-label">Maat</span>
                <select id="ts-input"><option value="4">4/4</option><option value="3">3/4</option><option value="2">2/4</option><option value="6">6/8</option></select>
            </div>
        </div>

        <div class="row-group">
            <div class="control-group">
                <span class="input-label">Modus</span>
                <select id="play-mode"><option value="guide">Begeleiding</option><option value="clean">Schoon</option></select>
            </div>
            <div class="control-group">
                <span class="input-label">Glide</span>
                <input type="range" id="glide-input" min="0" max="40" value="15" style="width: 60px;">
            </div>
        </div>

        <div class="row-group" style="margin-top: 5px;">
            <label style="text-align:center"><span class="input-label">Metro</span><br><input type="checkbox" id="metronome-on" checked></label>
            <button id="undo-btn" class="btn">Undo</button>
            <button id="confirm-btn" class="btn" style="display:none; background: #eee;">Ok (<span id="m-count">1</span>)</button>
            <button id="start-btn" class="btn" style="background: #2ecc71; border-color: #000;">START</button>
        </div>
    </div>
</header>

<div id="content-wrapper">
    <div id="viewer-container">
        <div id="scanning-line"><div id="beat-bubble">M 1 | B 1</div></div>
    </div>
</div>

<div id="performance-overlay">
    <button id="pause-btn" class="btn" style="flex:1;">PAUZE</button>
    <button id="stop-btn" class="btn" style="flex:1; background:#e74c3c; color:white;">STOP</button>
</div>

<script>
    const Engine = {
        pdf: null, systems: [], currentSystem: null,
        state: 'IDLE', isRunning: false, isPaused: false,
        audioCtx: null, visualHistory: [], lastBeat: -1,
        colors: ['var(--m1)', 'var(--m2)', 'var(--m3)', 'var(--m4)'],

        init() {
            this.bindEvents();
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        },

        bindEvents() {
            document.getElementById('upload-pdf').onchange = (e) => this.loadPDF(e);
            document.getElementById('viewer-container').onmousedown = (e) => this.handleMarking(e);
            document.getElementById('confirm-btn').onclick = () => this.confirmSystem();
            document.getElementById('undo-btn').onclick = () => this.undo();
            document.getElementById('start-btn').onclick = () => this.start();
            document.getElementById('stop-btn').onclick = () => this.stop();
            document.getElementById('pause-btn').onclick = () => this.togglePause();
        },

        async loadPDF(e) {
            const file = e.target.files[0]; if (!file) return;
            this.updateStatus("Laden...");
            const buffer = await file.arrayBuffer();
            this.pdf = await pdfjsLib.getDocument(buffer).promise;
            const container = document.getElementById('viewer-container');
            container.querySelectorAll('canvas').forEach(c => c.remove());

            for (let i = 1; i <= this.pdf.numPages; i++) {
                const page = await this.pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                container.appendChild(canvas);
            }
            this.state = 'TOP'; this.updateStatus("Klik BOVENKANT regel");
        },

        handleMarking(e) {
            if (this.state === 'IDLE' || this.isRunning) return;
            const container = document.getElementById('viewer-container');
            const rect = container.getBoundingClientRect();
            const y = ((e.pageY - (rect.top + window.scrollY)) / container.scrollHeight) * 100;
            const x = ((e.pageX - rect.left) / rect.width) * 100;

            if (this.state === 'TOP') {
                this.currentSystem = { top: y, bottom: 0, measures: [], blocks: [] };
                this.state = 'BOTTOM'; this.updateStatus("Klik ONDERKANT regel");
            } else if (this.state === 'BOTTOM') {
                this.currentSystem.bottom = y;
                this.createUI(y);
                this.state = 'MEASURES'; this.updateStatus("Klik Maatstrepen | Bevestig");
                document.getElementById('confirm-btn').style.display = 'inline-block';
            } else if (this.state === 'MEASURES') {
                this.addM(x);
            }
        },

        createUI(by) {
            const c = document.getElementById('viewer-container');
            const box = document.createElement('div'); box.className = 'system-box';
            box.style.top = this.currentSystem.top + '%'; box.style.height = (by - this.currentSystem.top) + '%';
            const lb = document.createElement('div'); lb.className = 'label-tag';
            lb.style.top = ((this.currentSystem.top + by) / 2) + '%';
            c.appendChild(box); c.appendChild(lb);
            this.currentSystem.boxEl = box; this.currentSystem.labelEl = lb;
            this.visualHistory.push({ type: 'BOX', el: box, lb: lb });
            this.refreshLb();
        },

        addM(x) {
            const lx = this.currentSystem.measures.length > 0 ? this.currentSystem.measures[this.currentSystem.measures.length - 1] : 0;
            const mi = this.currentSystem.measures.length;
            this.currentSystem.measures.push(x);
            const b = document.createElement('div'); b.className = 'measure-block';
            b.style.top = this.currentSystem.top + '%'; b.style.height = (this.currentSystem.bottom - this.currentSystem.top) + '%';
            b.style.left = lx + '%'; b.style.width = (x - lx) + '%';
            b.style.background = this.colors[mi % 4];
            document.getElementById('viewer-container').appendChild(b);
            this.currentSystem.blocks.push(b);
            this.visualHistory.push({ type: 'MEASURE', el: b });
            this.refreshLb();
        },

        confirmSystem() {
            const lx = this.currentSystem.measures.length > 0 ? this.currentSystem.measures[this.currentSystem.measures.length - 1] : 0;
            const mi = this.currentSystem.measures.length;
            const fb = document.createElement('div'); fb.className = 'measure-block';
            fb.style.top = this.currentSystem.top + '%'; fb.style.height = (this.currentSystem.bottom - this.currentSystem.top) + '%';
            fb.style.left = lx + '%'; fb.style.width = (100 - lx) + '%';
            fb.style.background = this.colors[mi % 4];
            document.getElementById('viewer-container').appendChild(fb);
            this.currentSystem.blocks.push(fb);
            this.systems.push(this.currentSystem);
            this.currentSystem = null; this.visualHistory = []; this.state = 'TOP';
            this.updateStatus("Regel OK. Volgende?");
            document.getElementById('confirm-btn').style.display = 'none';
        },

        undo() {
            if (!this.visualHistory.length) return;
            const item = this.visualHistory.pop(); item.el.remove();
            if (item.type === 'MEASURE') { this.currentSystem.measures.pop(); this.currentSystem.blocks.pop(); }
            else { item.lb.remove(); this.currentSystem = null; this.state = 'TOP'; document.getElementById('confirm-btn').style.display = 'none'; }
            this.refreshLb();
        },

        refreshLb() {
            if (!this.currentSystem) return;
            const c = this.currentSystem.measures.length + 1;
            const b = c * parseInt(document.getElementById('ts-input').value);
            document.getElementById('m-count').innerText = c;
            this.currentSystem.labelEl.innerHTML = `R${this.systems.length + 1}: ${c}M | ${b}B`;
        },

        updateStatus(m) { document.getElementById('step-info').innerText = m; },

        async start() {
            if (!this.systems.length) return;
            this.isRunning = true;
            const mode = document.getElementById('play-mode').value;
            document.getElementById('main-body').className = (mode === 'clean' ? 'play-clean' : 'play-guide');
            document.getElementById('master-header').style.transform = 'translateY(-100%)';
            document.getElementById('performance-overlay').style.display = 'flex';
            document.getElementById('scanning-line').style.display = 'block';

            const bpm = parseInt(document.getElementById('bpm-input').value);
            const ts = parseInt(document.getElementById('ts-input').value);
            const glide = parseInt(document.getElementById('glide-input').value) / 100;

            for (let i = 0; i < this.systems.length; i++) {
                if (!this.isRunning) break;
                await this.playSys(this.systems[i], i, bpm, ts, glide);
            }
            this.stop();
        },

        playSys(sys, idx, bpm, ts, gF) {
            return new Promise(res => {
                const nM = sys.blocks.length; const tD = (nM * ts / bpm) * 60;
                const trD = (idx < this.systems.length - 1) ? tD * gF : 0;
                const sD = tD - trD; let sT = performance.now(); this.lastBeat = -1;

                const tick = (now) => {
                    if (!this.isRunning) return res();
                    if (this.isPaused) { sT += (performance.now() - now); requestAnimationFrame(tick); return; }
                    const el = (now - sT) / 1000;
                    const pr = Math.min(el / tD, 0.999);
                    const cB = Math.floor(pr * (nM * ts));

                    if (cB !== this.lastBeat) {
                        this.click(cB % ts === 0); this.lastBeat = cB;
                        document.getElementById('beat-bubble').innerText = `M${Math.floor(cB/ts)+1} â€¢ B${(cB%ts)+1}`;
                    }
                    sys.blocks.forEach((b, k) => b.classList.toggle('active', k === Math.floor(cB/ts)));

                    let y;
                    if (el <= sD) y = sys.top + (el * ((sys.bottom - sys.top) / sD));
                    else if (idx < this.systems.length - 1) y = sys.bottom + (this.systems[idx+1].top - sys.bottom) * ((el - sD) / trD);
                    else y = sys.bottom;

                    const line = document.getElementById('scanning-line');
                    line.style.top = y + '%';
                    const r = line.getBoundingClientRect();
                    if (r.top > window.innerHeight * 0.45) window.scrollBy(0, r.top - window.innerHeight * 0.45);

                    if (el < tD) requestAnimationFrame(tick); else res();
                };
                requestAnimationFrame(tick);
            });
        },

        click(h) {
            if (!document.getElementById('metronome-on').checked) return;
            if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const o = this.audioCtx.createOscillator(); const g = this.audioCtx.createGain();
            o.connect(g); g.connect(this.audioCtx.destination);
            o.frequency.value = h ? 1000 : 600;
            g.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.05);
            o.start(); o.stop(this.audioCtx.currentTime + 0.05);
        },

        togglePause() { this.isPaused = !this.isPaused; document.getElementById('pause-btn').innerText = this.isPaused ? "RESUME" : "PAUZE"; },

        stop() {
            this.isRunning = false; document.getElementById('main-body').className = '';
            document.getElementById('master-header').style.transform = 'translateY(0)';
            document.getElementById('performance-overlay').style.display = 'none';
            document.getElementById('scanning-line').style.display = 'none';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    };
    Engine.init();
</script>
</body>
</html>
