<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Maestro - Precision Sheet Scroller</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        :root { 
            --gold: #c5a059; --cream: #fdfaf0; --midnight: #1a1a1a; 
            --panel: #2c2c2c; --accent: #e67e22; --measure-a: rgba(197, 160, 89, 0.2); 
            --measure-b: rgba(197, 160, 89, 0.1);
        }

        body { 
            font-family: 'Georgia', serif; margin: 0; background: var(--midnight); 
            color: var(--cream); overflow-x: hidden; 
        }

        /* --- UI HEADER --- */
        #master-header { 
            position: fixed; top: 0; width: 100%; z-index: 100000;
            background: var(--panel); border-bottom: 2px solid var(--gold);
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        .status-bar { 
            background: var(--gold); color: var(--midnight); 
            text-align: center; padding: 5px; font-weight: bold; font-size: 13px; text-transform: uppercase;
        }

        .nav-container { 
            display: flex; gap: 15px; padding: 12px; align-items: center; 
            justify-content: center; flex-wrap: wrap; 
        }

        /* --- Knoppen & Inputs --- */
        .btn { 
            padding: 8px 16px; border: 1px solid var(--gold); border-radius: 4px; 
            background: transparent; color: var(--gold); cursor: pointer; 
            font-weight: bold; transition: all 0.3s; font-family: 'Georgia', serif;
        }
        .btn:hover { background: var(--gold); color: var(--midnight); }
        .btn-primary { background: var(--gold); color: var(--midnight); }
        .btn-danger { color: #e74c3c; border-color: #e74c3c; }

        input, select { 
            background: #3d3d3d; border: 1px solid #555; color: white; 
            padding: 6px; border-radius: 4px; outline: none;
        }

        /* --- PDF AREA --- */
        #viewer-container { 
            position: relative; width: 100%; padding-top: 170px; 
            display: flex; flex-direction: column; align-items: center;
            background: var(--cream); /* Klassieke papier-look onder de PDF */
        }
        canvas { box-shadow: 0 0 30px rgba(0,0,0,0.3); margin-bottom: 20px; max-width: 95%; }

        /* --- MARKERS --- */
        #scanning-line { 
            position: absolute; left: 0; width: 100%; height: 4px; 
            background: #d35400; box-shadow: 0 0 10px #d35400; 
            z-index: 99999; display: none; pointer-events: none;
        }
        #beat-bubble {
            position: absolute; left: 50%; bottom: -35px; transform: translateX(-50%);
            background: #d35400; color: white; padding: 3px 12px; border-radius: 15px;
            font-size: 12px; font-weight: bold; font-family: sans-serif;
        }

        .system-box { position: absolute; left: 0; width: 100%; border: 1px solid var(--gold); pointer-events: none; z-index: 10; opacity: 0.5; }
        .measure-block { position: absolute; pointer-events: none; border-right: 1px solid rgba(0,0,0,0.1); z-index: 5; }
        .measure-block.active { background: rgba(197, 160, 89, 0.4) !important; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
        
        .label-tag { 
            position: absolute; right: 15px; background: var(--panel); color: var(--gold); 
            border: 1px solid var(--gold); padding: 5px 10px; border-radius: 3px;
            font-size: 11px; z-index: 20; transform: translateY(-50%); text-align: right;
        }

        /* --- MODES --- */
        body.play-clean #scanning-line, body.play-clean .system-box, 
        body.play-clean .label-tag, body.play-clean .measure-block { opacity: 0 !important; }

        body.play-guide .system-box, body.play-guide .label-tag { opacity: 0.1; }
        body.play-guide .measure-block { opacity: 0; }
        body.play-guide .measure-block.active { opacity: 1 !important; }

        #performance-overlay { 
            position: fixed; bottom: 30px; right: 30px; z-index: 110000; 
            display: none; gap: 15px; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px;
        }
    </style>
</head>
<body id="main-body">

<header id="master-header">
    <div class="status-bar" id="step-info">Laad een partituur om te beginnen</div>
    <div class="nav-container">
        <input type="file" id="upload-pdf" accept="application/pdf">
        
        <div>BPM <input type="number" id="bpm-input" value="120" style="width:50px;"></div>
        
        <select id="ts-input">
            <option value="4">4/4 Maat</option>
            <option value="3">3/4 Maat</option>
            <option value="2">2/4 Maat</option>
            <option value="6">6/8 Maat</option>
        </select>

        <select id="play-mode">
            <option value="guide">Modus: Begeleiding</option>
            <option value="clean">Modus: Schoon</option>
        </select>

        <div style="font-size: 11px;">
            Glide <input type="range" id="glide-input" min="0" max="40" value="15">
        </div>

        <label title="Metronoom">ðŸ”Š <input type="checkbox" id="metronome-on" checked></label>
        
        <button id="undo-btn" class="btn">Undo</button>
        <button id="confirm-btn" class="btn btn-primary" style="display:none;">Bevestig Regel (<span id="m-count">1</span>)</button>
        <button id="start-btn" class="btn btn-primary">START</button>
    </div>
</header>

<div id="performance-overlay">
    <button id="pause-btn" class="btn">PAUZE</button>
    <button id="stop-btn" class="btn btn-danger">STOP</button>
</div>

<div id="viewer-container">
    <div id="scanning-line"><div id="beat-bubble">M 1 | B 1</div></div>
</div>

<script>
    /**
     * THE MAESTRO - CORE ENGINE
     */
    const Engine = {
        pdf: null,
        systems: [],
        currentSystem: null,
        state: 'IDLE',
        isRunning: false,
        isPaused: false,
        audioCtx: null,
        visualHistory: [],
        lastBeat: -1,

        init() {
            this.bindEvents();
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        },

        bindEvents() {
            document.getElementById('upload-pdf').onchange = (e) => this.loadPDF(e);
            document.getElementById('viewer-container').onmousedown = (e) => this.handleMarking(e);
            document.getElementById('confirm-btn').onclick = () => this.confirmSystem();
            document.getElementById('undo-btn').onclick = () => this.undo();
            document.getElementById('start-btn').onclick = () => this.start();
            document.getElementById('stop-btn').onclick = () => this.stop();
            document.getElementById('pause-btn').onclick = () => this.togglePause();
        },

        async loadPDF(e) {
            const file = e.target.files[0];
            if (!file) return;
            this.updateStatus("Bezig met laden...");
            const buffer = await file.arrayBuffer();
            this.pdf = await pdfjsLib.getDocument(buffer).promise;
            
            const container = document.getElementById('viewer-container');
            container.querySelectorAll('canvas').forEach(c => c.remove());

            for (let i = 1; i <= this.pdf.numPages; i++) {
                const page = await this.pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                container.appendChild(canvas);
            }
            this.state = 'TOP';
            this.updateStatus("Klik op de BOVENKANT van de eerste regel");
        },

        handleMarking(e) {
            if (this.state === 'IDLE' || this.isRunning) return;
            const container = document.getElementById('viewer-container');
            const rect = container.getBoundingClientRect();
            const yPct = ((e.pageY - (rect.top + window.scrollY)) / container.scrollHeight) * 100;
            const xPct = ((e.pageX - rect.left) / rect.width) * 100;

            if (this.state === 'TOP') {
                this.currentSystem = { top: yPct, bottom: 0, measures: [], blocks: [] };
                this.state = 'BOTTOM';
                this.updateStatus("Klik op de ONDERKANT van de regel");
            } else if (this.state === 'BOTTOM') {
                this.currentSystem.bottom = yPct;
                this.createSystemUI(yPct);
                this.state = 'MEASURES';
                this.updateStatus("Markeer de maatstrepen en klik 'Bevestig'");
                document.getElementById('confirm-btn').style.display = 'inline-block';
            } else if (this.state === 'MEASURES') {
                this.addMeasure(xPct);
            }
        },

        createSystemUI(bottomY) {
            const container = document.getElementById('viewer-container');
            const box = document.createElement('div');
            box.className = 'system-box';
            box.style.top = this.currentSystem.top + '%';
            box.style.height = (bottomY - this.currentSystem.top) + '%';
            
            const label = document.createElement('div');
            label.className = 'label-tag';
            label.style.top = ((this.currentSystem.top + bottomY) / 2) + '%';
            
            container.appendChild(box);
            container.appendChild(label);
            this.currentSystem.boxEl = box;
            this.currentSystem.labelEl = label;
            this.visualHistory.push({ type: 'BOX', el: box, labelEl: label });
            this.refreshLabel();
        },

        addMeasure(x) {
            const lastX = this.currentSystem.measures.length > 0 ? this.currentSystem.measures[this.currentSystem.measures.length - 1] : 0;
            this.currentSystem.measures.push(x);
            
            const block = document.createElement('div');
            block.className = 'measure-block';
            block.style.top = this.currentSystem.top + '%';
            block.style.height = (this.currentSystem.bottom - this.currentSystem.top) + '%';
            block.style.left = lastX + '%';
            block.style.width = (x - lastX) + '%';
            block.style.background = this.currentSystem.measures.length % 2 === 0 ? 'var(--measure-b)' : 'var(--measure-a)';
            
            document.getElementById('viewer-container').appendChild(block);
            this.currentSystem.blocks.push(block);
            this.visualHistory.push({ type: 'MEASURE', el: block });
            this.refreshLabel();
        },

        confirmSystem() {
            // Voeg laatste maat toe (naar 100%)
            const lastX = this.currentSystem.measures.length > 0 ? this.currentSystem.measures[this.currentSystem.measures.length - 1] : 0;
            const finalBlock = document.createElement('div');
            finalBlock.className = 'measure-block';
            finalBlock.style.top = this.currentSystem.top + '%';
            finalBlock.style.height = (this.currentSystem.bottom - this.currentSystem.top) + '%';
            finalBlock.style.left = lastX + '%';
            finalBlock.style.width = (100 - lastX) + '%';
            finalBlock.style.background = (this.currentSystem.measures.length + 1) % 2 === 0 ? 'var(--measure-b)' : 'var(--measure-a)';
            
            document.getElementById('viewer-container').appendChild(finalBlock);
            this.currentSystem.blocks.push(finalBlock);
            
            this.systems.push(this.currentSystem);
            this.currentSystem = null;
            this.visualHistory = [];
            this.state = 'TOP';
            this.updateStatus("Regel bevestigd. Volgende regel of start?");
            document.getElementById('confirm-btn').style.display = 'none';
        },

        undo() {
            if (!this.visualHistory.length) return;
            const item = this.visualHistory.pop();
            item.el.remove();
            if (item.type === 'MEASURE') {
                this.currentSystem.measures.pop();
                this.currentSystem.blocks.pop();
            } else {
                item.labelEl.remove();
                this.currentSystem = null;
                this.state = 'TOP';
                document.getElementById('confirm-btn').style.display = 'none';
            }
            this.refreshLabel();
        },

        refreshLabel() {
            if (!this.currentSystem) return;
            const count = this.currentSystem.measures.length + 1;
            const beats = count * parseInt(document.getElementById('ts-input').value);
            document.getElementById('m-count').innerText = count;
            this.currentSystem.labelEl.innerHTML = `Regel ${this.systems.length + 1}<br>${count} Maten | ${beats} Beats`;
        },

        updateStatus(msg) {
            document.getElementById('step-info').innerText = msg;
        },

        async start() {
            if (!this.systems.length) return;
            this.isRunning = true;
            this.isPaused = false;
            
            const mode = document.getElementById('play-mode').value;
            document.getElementById('main-body').className = (mode === 'clean' ? 'play-clean' : 'play-guide');
            document.getElementById('master-header').style.visibility = 'hidden';
            document.getElementById('performance-overlay').style.display = 'flex';
            document.getElementById('scanning-line').style.display = 'block';

            const bpm = parseInt(document.getElementById('bpm-input').value);
            const ts = parseInt(document.getElementById('ts-input').value);
            const glide = parseInt(document.getElementById('glide-input').value) / 100;

            for (let i = 0; i < this.systems.length; i++) {
                if (!this.isRunning) break;
                await this.playSystem(this.systems[i], i, bpm, ts, glide);
            }
            this.stop();
        },

        playSystem(sys, idx, bpm, ts, glideFactor) {
            return new Promise(resolve => {
                const numM = sys.blocks.length;
                const totalDur = (numM * ts / bpm) * 60;
                const transDur = (idx < this.systems.length - 1) ? totalDur * glideFactor : 0;
                const scanDur = totalDur - transDur;
                let startTime = performance.now();
                this.lastBeat = -1;

                const tick = (now) => {
                    if (!this.isRunning) return resolve();
                    if (this.isPaused) { 
                        startTime += (performance.now() - now); 
                        scrollAnimationFrame = requestAnimationFrame(tick); 
                        return; 
                    }

                    const elapsed = (now - startTime) / 1000;
                    
                    // Audio & Beat Bubble
                    const progress = Math.min(elapsed / totalDur, 0.999);
                    const totalBeats = numM * ts;
                    const curBeat = Math.floor(progress * totalBeats);
                    if (curBeat !== this.lastBeat) {
                        this.click(curBeat % ts === 0);
                        this.lastBeat = curBeat;
                        document.getElementById('beat-bubble').innerText = `M ${Math.floor(curBeat/ts)+1} | B ${(curBeat%ts)+1}`;
                    }

                    // Highlight
                    sys.blocks.forEach((b, k) => b.classList.toggle('active', k === Math.floor(curBeat/ts)));

                    // Y-Positie & Scroll
                    let y;
                    if (elapsed <= scanDur) {
                        y = sys.top + (elapsed * ((sys.bottom - sys.top) / scanDur));
                    } else if (idx < this.systems.length - 1) {
                        const p = (elapsed - scanDur) / transDur;
                        y = sys.bottom + (this.systems[idx+1].top - sys.bottom) * p;
                    } else { y = sys.bottom; }

                    const line = document.getElementById('scanning-line');
                    line.style.top = y + '%';
                    
                    const rect = line.getBoundingClientRect();
                    if (rect.top > window.innerHeight * 0.5) {
                        window.scrollBy(0, rect.top - window.innerHeight * 0.5);
                    }

                    if (elapsed < totalDur) requestAnimationFrame(tick);
                    else resolve();
                };
                requestAnimationFrame(tick);
            });
        },

        click(high) {
            if (!document.getElementById('metronome-on').checked) return;
            if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = this.audioCtx.createOscillator();
            const g = this.audioCtx.createGain();
            osc.connect(g); g.connect(this.audioCtx.destination);
            osc.frequency.value = high ? 1000 : 600;
            g.gain.setValueAtTime(0.1, this.audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(this.audioCtx.currentTime + 0.05);
        },

        togglePause() {
            this.isPaused = !this.isPaused;
            document.getElementById('pause-btn').innerText = this.isPaused ? "VERDER" : "PAUZE";
        },

        stop() {
            this.isRunning = false;
            document.getElementById('main-body').className = '';
            document.getElementById('master-header').style.visibility = 'visible';
            document.getElementById('performance-overlay').style.display = 'none';
            document.getElementById('scanning-line').style.display = 'none';
            this.systems.forEach(s => s.blocks.forEach(b => b.classList.remove('active')));
            window.scrollTo(0, 0);
        }
    };

    Engine.init();
</script>

</body>
</html>
